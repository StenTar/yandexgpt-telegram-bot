#!/bin/bash
# deploy-staging.sh - –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ —Å—Ç–µ–Ω–¥–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è –Ω–∞ —Å—Ç–µ–Ω–¥–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä..."

# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–ª—É–∂–±—É –µ—Å–ª–∏ –æ–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
sudo systemctl stop telegram-bot 2>/dev/null || true

# 2. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –∏–∑ GitLab
cd /opt/ytb
git pull gitlab master

# 3. –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
venv/bin/pip install -r requirements.txt

# 4. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è —Å—Ç–µ–Ω–¥–∞
if [ -f .env.staging ]; then
    cp .env.staging .env
    echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å—Ç–µ–Ω–¥–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞"
else
    echo "‚ö†Ô∏è –§–∞–π–ª .env.staging –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π .env"
fi

# 5. –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É –¥–ª—è –ª–æ–≥–æ–≤ –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç
mkdir -p /opt/ytb/logs

# 6. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–ª—É–∂–±—É
sudo systemctl daemon-reload
sudo systemctl start telegram-bot

# 7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
echo "üìä –°—Ç–∞—Ç—É—Å —Å–ª—É–∂–±—ã:"
sudo systemctl status telegram-bot --no-pager

echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
